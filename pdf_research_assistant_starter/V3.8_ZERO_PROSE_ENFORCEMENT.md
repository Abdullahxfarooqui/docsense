# üö® V3.8 Zero-Prose Enforcement - Complete Elimination of Analytical Text

## üìå Critical Upgrade Summary

**Version 3.8** introduces **deterministic, table-only output** for all numeric/entity extraction queries. This completely eliminates the problem of LLMs generating long analytical essays ("Introduction", "Key Insights", "Conclusion") when users explicitly request structured data.

---

## ‚ö†Ô∏è Problem Statement

**Previous Behavior (V3.7 and earlier):**
- User queries: "Show all parameters for each entity"
- System returns: Long essay with Introduction, Key Insights, Analytical Discussion, Conclusion, etc.
- Expected: **Clean entity-based table with NO prose**

**Root Cause:**
- LLMs naturally want to explain and analyze
- System prompt wasn't strict enough to prevent analytical text
- No explicit enforcement of "first character must be |"

---

## ‚úÖ Solution: V3.8 Zero-Prose Enforcement

### **Critical Changes:**

1. **Expanded Numeric Mode Triggers (Lines 256-273)**
   - Added entity-based query patterns:
     * "show all parameters"
     * "list all parameters"
     * "parameters for each"
     * "for each entity"
     * "all entities"
     * "entity data"
     * "data for all"
     * "values from document"

2. **Completely Rewritten System Prompt (Lines 832-950)**
   - **ZERO-PROSE ENFORCEMENT** section at top
   - Explicit prohibition of specific phrases:
     * "Introduction", "Key Insights", "Summary", "Conclusion"
     * "Based on the document...", "Here is the data..."
     * "The analysis shows...", "We can see that..."
   - Mandatory rule: **First character must be "|" (pipe) or "[" (bracket for JSON)**

3. **Entity-Based Output Format (Lines 917-945)**
   - **Wide Entity Table (PREFERRED):**
     ```markdown
     | Entity | Pressure | Temperature | Volume | API Gravity | Type | Sales Code | Ticket | Notes |
     |--------|----------|-------------|--------|-------------|------|------------|--------|-------|
     | TAIMUR | 327.07 psig | 301.911 ¬∞F | 327.07 bbl | ‚Äî | OIL | 5515 | 77826136 | Explicit |
     | CONDEN | 0 psig | ‚Äî | 0 bbl | ‚Äî | CONDEN | ####### | f7f6faf7f | Explicit |
     ```
   
   - **Long Parameter Table (if too many columns):**
     ```markdown
     | Entity | Parameter | Value | Unit | Notes |
     |--------|-----------|-------|------|-------|
     | TAIMUR | Pressure | 327.07 | psig | Explicit |
     | TAIMUR | Temperature | 301.911 | ¬∞F | Explicit |
     ```

4. **Enhanced Extraction Protocol (Lines 951-1012)**
   - **1. Detect ALL entities** (TAIMUR, LPG, CONDEN, Tank-C:MARI DEEP, Well-7)
   - **2. Extract ALL parameters** (numeric + text):
     * Numeric: Pressure, Temperature, Volume, API Gravity, Energy, Flow
     * Text: Product, Type, Sales Code, Ticket, Status, Storage, Notes
   - **3. Group by entity** (one row per entity with all parameters merged)
   - **4. Handle missing values** (use "‚Äî", never "NULL", "N/A", "0")
   - **5. Include units** (psig, ¬∞F, bbl, dAPI in cell or separate column)
   - **6. Notes column** ("Explicit" or "Inferred from context")

5. **Concrete Examples with Violations (Lines 1014-1080)**
   - Shows correct vs wrong output
   - Highlights common violations (prose before table, placeholder names, missing text columns)

---

## üéØ Expected Behavior

### **Query:** "Show all parameters for each entity"

**Document Contains:**
```
TAIMUR: Product=OIL, Pressure=327.07 psig, Temperature=301.911¬∞F, Volume=327.07 bbl, Sales Code=5515, Ticket=77826136
CONDEN: Product=CONDEN, Pressure=0 psig, Volume=0 bbl, Sales Code=#######, Ticket=f7f6faf7f
LPG: Product=LPG, Pressure=0 psig, Temperature=302¬∞F, Volume=301.925 bbl, Ticket=4084bd2
```

**‚úÖ V3.8 Correct Output:**
```markdown
| Entity | Pressure | Temperature | Volume | Type | Sales Code | Ticket | Notes |
|--------|----------|-------------|--------|------|------------|--------|-------|
| TAIMUR | 327.07 psig | 301.911 ¬∞F | 327.07 bbl | OIL | 5515 | 77826136 | Explicit |
| CONDEN | 0 psig | ‚Äî | 0 bbl | CONDEN | ####### | f7f6faf7f | Explicit |
| LPG | 0 psig | 302 ¬∞F | 301.925 bbl | LPG | ‚Äî | 4084bd2 | Explicit |
```

**‚ùå V3.7 Wrong Output (with prose):**
```
Based on the document, here are the parameters for each entity:

**Introduction:**
The following entities have been identified in the document with their respective parameters...

**Key Findings:**
- TAIMUR shows a pressure of 327.07 psig with a temperature of 301.911¬∞F
- CONDEN has zero pressure indicating...

| Entity | Pressure | Temperature |
|--------|----------|-------------|
| TAIMUR | 327.07 psig | 301.911 ¬∞F |
...
```

---

## üö´ Absolute Prohibitions

### **NEVER Write These Phrases:**
- "Introduction"
- "Key Insights"
- "Summary"
- "Conclusion"
- "Findings"
- "Based on the document..."
- "Here is the data..."
- "According to..."
- "The analysis shows..."
- "We can see that..."
- "In summary..."
- "To conclude..."
- "As shown in..."

### **NEVER Use Placeholder Names:**
- "Source 1", "Source 2", "Source 3"
- "Sheet1", "Sheet2" (unless that's the ACTUAL name in document)
- "Location A", "Location B"
- "Entity 1", "Entity 2"

### **NEVER Analyze or Interpret:**
- No comparisons ("TAIMUR has higher pressure than...")
- No trends ("Pressure is increasing...")
- No recommendations ("Consider checking...")
- No observations ("Notably, the temperature...")

---

## ‚úÖ Mandatory Rules

1. **START IMMEDIATELY WITH TABLE** - First character must be "|" (pipe)
2. **USE REAL ENTITY/LOCATION NAMES** - Extract from document (TAIMUR, LPG, Tank-C:MARI DEEP)
3. **INCLUDE ALL PARAMETERS** - Numeric (Pressure, Temperature) AND text (Product, Type, Sales Code, Ticket)
4. **SHOW "‚Äî" FOR MISSING VALUES** - Never use "NULL", "Not found", "N/A"
5. **INCLUDE UNITS** - psig, ¬∞F, bbl, dAPI, MMBtu, mcf, ft, gal
6. **MERGE DUPLICATES** - One row per entity with ALL parameters in columns
7. **END IMMEDIATELY AFTER TABLE** - No closing text

---

## üß™ Testing Instructions

### **Test 1: Basic Entity Extraction**
**Query:** "Show all parameters for each entity"
**Expected:**
- Table starts immediately (first character is "|")
- Real entity names (TAIMUR, LPG, CONDEN)
- All numeric + text parameters
- "‚Äî" for missing values
- NO prose before or after table

### **Test 2: Multi-File Entity Merging**
**Query:** "List data for all entities"
**Upload:** 2+ files with same entity (TAIMUR in file1.pdf and file2.xlsx)
**Expected:**
- Single TAIMUR row with merged data
- All parameters from both files
- Sources metadata shows both files

### **Test 3: Ambiguous Query**
**Query:** "What data is available?"
**Expected:**
- System triggers numeric mode (because of entity patterns)
- Returns entity table
- NO explanatory text

### **Test 4: Text Parameters Included**
**Query:** "Extract all data"
**Expected:**
- Table includes text columns (Product, Type, Sales Code, Ticket, Status)
- NOT just numeric columns (Pressure, Temperature, Volume)

### **Test 5: Missing Values**
**Query:** "Show all parameters for TAIMUR"
**Document:** TAIMUR has Pressure and Volume, but NO Temperature
**Expected:**
- Temperature column shows "‚Äî" (not NULL, N/A, or 0)
- Pressure and Volume show actual values

---

## üîé Verification Checklist

**Check Output Format:**
- [ ] First character is "|" (pipe) or "[" (bracket for JSON)
- [ ] NO text before table
- [ ] NO text after table (except ONE calculation line if user requested)
- [ ] Using REAL entity names from document (TAIMUR, LPG, CONDEN)

**Check Parameter Completeness:**
- [ ] Included ALL numeric parameters (Pressure, Temperature, Volume, API, etc.)
- [ ] Included ALL text parameters (Product, Type, Sales Code, Ticket, Status)
- [ ] NOT skipping text columns

**Check Missing Value Handling:**
- [ ] Missing values show "‚Äî" (not NULL, N/A, 0)
- [ ] Only use "0" if zero is EXPLICITLY in document

**Check Units:**
- [ ] Included units (psig, ¬∞F, bbl, dAPI) either in cell or separate column
- [ ] Units match parameter type

**Check Entity Merging:**
- [ ] One row per entity with all parameters merged
- [ ] NO duplicate rows for same entity
- [ ] If entity appears in multiple chunks/files ‚Üí single row

**Check for Violations:**
- [ ] NO "Introduction:", "Summary:", "Conclusion:" headers
- [ ] NO explanatory paragraphs
- [ ] NO placeholder names (Source 1/2/3, Sheet1/2)
- [ ] NO analytical text ("The data shows...", "Notably...")

---

## üêõ Troubleshooting

### **Issue: LLM still writes prose before table**
**Solution:**
- Check if query triggered numeric mode (look for log: "üìä Data Type: NUMERIC")
- If not, add query pattern to `strict_numeric_triggers` in detect_data_type()
- Verify system prompt has "First character must be |" rule

### **Issue: Using "Source 1/2/3" instead of real names**
**Solution:**
- Ensure entity extraction is active (log: "üîç Applying entity-based extraction...")
- Check entity patterns in entity_extractor.py
- Verify entity names are uppercase (TAIMUR, not Taimur)

### **Issue: Missing text parameters (Product, Sales Code, Ticket)**
**Solution:**
- Check extraction protocol in system prompt
- Ensure "Extract ALL parameters" rule is present
- Verify PARAMETER_PATTERNS in entity_extractor.py includes text types

### **Issue: Using "NULL" instead of "‚Äî"**
**Solution:**
- Check missing value handling rules in system prompt
- Ensure "Use '‚Äî' for missing values" is emphasized
- Update entity_extractor.py to replace NULL with "‚Äî" in output

### **Issue: Entity extraction not triggered**
**Solution:**
- Check query triggers in detect_data_type() (line 256)
- Verify ENTITY_EXTRACTOR_AVAILABLE = True (startup log)
- Ensure numeric mode is detected (log: "üìä Data Type: NUMERIC")

---

## üìÇ Files Modified

### **document_mode.py (V3.8 Changes):**

**Lines 256-273:** Expanded numeric mode triggers
```python
# Added entity-based query patterns
'show all parameters', 'list all parameters', 'parameters for each',
'for each entity', 'all entities', 'each entity', 'entity data',
'data for all', 'values from document', 'from document'
```

**Lines 832-916:** Completely rewritten system prompt
```python
# V3.8 ZERO-PROSE ENFORCEMENT
system_message = """You are **DocSense** in **DETERMINISTIC TABLE EXTRACTION MODE** üìä

‚ö†Ô∏è V3.8 ZERO-PROSE ENFORCEMENT - CRITICAL DIRECTIVE ‚ö†Ô∏è

üö® ABSOLUTE PROHIBITION - NO EXCEPTIONS:
‚ùå NEVER write: "Introduction", "Key Insights", "Summary", "Conclusion"
‚ùå NEVER use placeholder labels: "Source 1/2/3", "Sheet1/2"
‚ùå NEVER analyze or interpret data

‚úÖ MANDATORY BEHAVIOR:
1Ô∏è‚É£ START IMMEDIATELY WITH TABLE - First character must be "|"
2Ô∏è‚É£ USE REAL ENTITY NAMES
3Ô∏è‚É£ INCLUDE ALL PARAMETERS (numeric + text)
...
```

**Lines 917-945:** Entity-based output formats
```python
# Wide Entity Table (PREFERRED)
| Entity | Pressure | Temperature | Volume | Type | Sales Code | Ticket | Notes |

# OR Long Parameter Table
| Entity | Parameter | Value | Unit | Notes |
```

**Lines 951-1012:** Enhanced extraction protocol
```python
1Ô∏è‚É£ DETECT ALL ENTITIES (TAIMUR, LPG, CONDEN, Tank-C:MARI DEEP)
2Ô∏è‚É£ EXTRACT ALL PARAMETERS (numeric + text)
3Ô∏è‚É£ GROUP BY ENTITY (one row per entity)
4Ô∏è‚É£ HANDLE MISSING VALUES (use "‚Äî")
5Ô∏è‚É£ INCLUDE UNITS (psig, ¬∞F, bbl, dAPI)
6Ô∏è‚É£ NOTES COLUMN ("Explicit" or "Inferred from context")
```

**Lines 1014-1080:** Concrete examples with violations
```python
‚úÖ CORRECT EXAMPLES
‚ùå WRONG EXAMPLES (prose before table, placeholder names, missing text columns)
```

---

## üéì Key Features

### **1. Deterministic Output**
No LLM creativity - strict table format only

### **2. Entity-Based Grouping**
One row per entity (TAIMUR, LPG, CONDEN) with all parameters merged

### **3. Text + Numeric Parameters**
Includes Product, Type, Sales Code, Ticket (not just Pressure/Temperature)

### **4. Clean Missing Values**
Shows "‚Äî" for missing data (not NULL, N/A, 0)

### **5. Real Names Only**
Extracts actual entity/location names (TAIMUR, Tank-C:MARI DEEP, not Source 1/2)

### **6. Zero Prose**
First character is "|" - no introductions, summaries, or conclusions

### **7. Cross-File Merging**
Same entity from multiple files ‚Üí single row with combined data

---

## üìä Comparison: V3.7 vs V3.8

| Feature | V3.7 | V3.8 |
|---------|------|------|
| **Prose Before Table** | Sometimes present | **ELIMINATED** |
| **Placeholder Names** | Sometimes used | **ELIMINATED** |
| **Text Parameters** | Sometimes skipped | **MANDATORY** |
| **Missing Values** | NULL or N/A | **Always "‚Äî"** |
| **First Character** | Variable | **Must be "\|"** |
| **Entity Triggers** | Limited | **Expanded** |
| **Enforcement** | Soft | **STRICT** |
| **Analytical Text** | Possible | **PROHIBITED** |

---

## üöÄ Next Steps

1. **Test Basic Extraction:**
   ```
   Query: "Show all parameters for each entity"
   Expected: Immediate table with entity names
   ```

2. **Test Multi-File Merging:**
   ```
   Upload: 2 files with TAIMUR data
   Expected: Single TAIMUR row with merged data
   ```

3. **Test Text Parameters:**
   ```
   Query: "Extract all data"
   Expected: Table includes Product, Type, Sales Code, Ticket columns
   ```

4. **Test Missing Values:**
   ```
   Document: TAIMUR has Pressure but no Temperature
   Expected: Temperature shows "‚Äî" (not NULL or 0)
   ```

5. **Verify Zero Prose:**
   ```
   Check: First character of response is "|"
   Check: NO text before or after table
   ```

---

## üî• Critical Reminders

1. **NO ESSAYS** - Table only, no analytical text
2. **NO INTRODUCTIONS** - Start with "|" immediately
3. **NO PLACEHOLDER NAMES** - Use TAIMUR, LPG, not Source 1/2
4. **INCLUDE TEXT COLUMNS** - Product, Type, Sales Code, Ticket, Status
5. **USE "‚Äî" FOR MISSING** - Never NULL, N/A, or invented zeros
6. **MERGE DUPLICATES** - One row per entity with all parameters
7. **REAL NAMES ONLY** - Extract from document, don't invent

---

## üìû Support

**Still seeing prose before tables?**
1. Check if numeric mode triggered (log: "üìä Data Type: NUMERIC")
2. Verify query matches triggers in detect_data_type() line 256
3. Check system prompt has "First character must be |" rule

**Missing text parameters?**
1. Check PARAMETER_PATTERNS in entity_extractor.py
2. Verify system prompt includes text parameter extraction
3. Ensure extraction protocol mentions Product, Type, Sales Code, Ticket

**Using placeholder names?**
1. Check entity extraction is active (log: "üîç Applying entity-based extraction...")
2. Verify entity patterns match your document's entity names
3. Ensure entities are uppercase (TAIMUR, not Taimur)

---

**Status**: ‚úÖ Complete and Active (V3.8)  
**Purpose**: Eliminate analytical text, enforce deterministic table-only output  
**Next**: User testing with entity-based queries
