# V3.6.1 - Extraction Logic Fix

## üêõ Issue Identified

When querying "Extract all data at each location", the system was creating rows for parameters that:
1. ‚ùå Don't exist in the document (showing "Not found")
2. ‚ùå Weren't requested by the user
3. ‚ùå Created duplicate/redundant rows

### **Example of Problem:**

**User uploaded file with:**
- TAIMUR: Temperature=301.925, Volume=0
- LPG: (no data)
- CONDEN: (no data)

**User query:** "Extract all data at each location"

**Wrong Output (V3.6):**
```
| Source          | Parameter   | Value | Unit | Notes      |
|-----------------|-------------|-------|------|------------|
| TAIMUR          | Temperature | 301.9 | degF | Explicit   |
| TAIMUR          | Volume      | 0     | bbl  | Explicit   |
| TANK Storage    | Pressure    | NULL  | psig | Not found  | ‚Üê WRONG!
| TANK Storage    | Temperature | NULL  | degF | Not found  | ‚Üê WRONG!
| DELIVER Delivery| Pressure    | NULL  | psig | Not found  | ‚Üê WRONG!
```

**Problems:**
1. Created rows for locations that don't have ANY data
2. Shows "Not found" for parameters that don't exist
3. Included Pressure even though it's not in the document

---

## ‚úÖ What Was Fixed

### **1. Added Rule: Only Extract Requested Parameters**

**New Instruction in System Prompt:**
```
2Ô∏è‚É£ ONLY EXTRACT PARAMETERS THAT EXIST IN THE DATA (CRITICAL):
   - ‚ö†Ô∏è DO NOT create rows for parameters the user didn't ask about
   - ‚ö†Ô∏è DO NOT invent parameters that don't exist in the document
   - ‚úÖ If user asks "extract pressure", ONLY show pressure data
   - ‚úÖ If user asks "extract all data", show ALL parameters that exist in document
   - ‚úÖ If a parameter column exists but has NULL for a location, include that row
   - ‚ùå If a parameter doesn't exist in the document at all, DO NOT create a row for it
```

### **2. Enhanced NULL Handling**

**Updated Rule:**
```
5Ô∏è‚É£ NULL/MISSING DATA HANDLING:
   - If cell value is NULL FOR A REQUESTED PARAMETER:
     * Value: NULL, Unit: correct, Notes: "Column exists but contains no data"
   - If parameter doesn't exist AND wasn't requested:
     * DO NOT create a row for it
   - IMPORTANT: Include rows with NULL values ONLY for parameters the user asked about
```

### **3. Added Clear Examples**

**Example 1: Specific Query**
```
User query: "Extract pressure at each location"
Document has: Temperature, Volume (no Pressure)

‚úÖ CORRECT: "The document does not contain pressure data. Available: Temperature, Volume"
‚ùå WRONG: Show "Pressure: NULL, Notes: Not found" for all locations
```

**Example 2: General Query**
```
User query: "Extract all data at each location"
Document has: TAIMUR (Temp: 301.9, Volume: 0), LPG (no data)

‚úÖ CORRECT: Only show TAIMUR rows (don't create empty rows for LPG)
‚ùå WRONG: Create rows for LPG with all NULLs
```

---

## üìã Expected Behavior Now

### **Test Case 1: Specific Parameter Query**

**Document:**
```
| Location | Temperature | Volume |
|----------|-------------|--------|
| TAIMUR   | 301.925     | 1500   |
| LPG      | NULL        | 2300   |
```

**Query:** "Extract pressure at each location"

**Expected Output:**
```
The document does not contain pressure data. Available parameters: Temperature, Volume
```

---

### **Test Case 2: All Data Query**

**Document:**
```
| Location | Temperature | Volume |
|----------|-------------|--------|
| TAIMUR   | 301.925     | 1500   |
| LPG      | NULL        | 2300   |
```

**Query:** "Extract all data at each location"

**Expected Output:**
```
| Source | Parameter   | Value   | Unit | Notes                              |
|--------|-------------|---------|------|------------------------------------|
| TAIMUR | Temperature | 301.925 | degF | Explicit                           |
| TAIMUR | Volume      | 1500    | bbl  | Explicit                           |
| LPG    | Temperature | NULL    | degF | Column exists but contains no data |
| LPG    | Volume      | 2300    | bbl  | Explicit                           |
```

**What Changed:**
- ‚úÖ Only shows parameters that exist in document (Temperature, Volume)
- ‚úÖ Doesn't create Pressure rows (not in document)
- ‚úÖ Shows NULL for LPG Temperature (column exists but empty)
- ‚úÖ Shows all locations that have AT LEAST ONE value

---

### **Test Case 3: Mixed Query**

**Document:**
```
| Location | Pressure | Temperature |
|----------|----------|-------------|
| TAIMUR   | NULL     | 301.9       |
| LPG      | 327.07   | NULL        |
| CONDEN   | 0        | 285.4       |
```

**Query:** "Extract pressure and temperature"

**Expected Output:**
```
| Source | Parameter   | Value  | Unit | Notes                              |
|--------|-------------|--------|------|------------------------------------|
| TAIMUR | Pressure    | NULL   | psig | Column exists but contains no data |
| TAIMUR | Temperature | 301.9  | degF | Explicit                           |
| LPG    | Pressure    | 327.07 | psig | Explicit                           |
| LPG    | Temperature | NULL   | degF | Column exists but contains no data |
| CONDEN | Pressure    | 0      | psig | Explicit zero value                |
| CONDEN | Temperature | 285.4  | degF | Explicit                           |
```

**What's Correct:**
- ‚úÖ Shows both requested parameters (Pressure, Temperature)
- ‚úÖ Includes NULLs where column exists but cell is empty
- ‚úÖ Distinguishes 0 from NULL
- ‚úÖ Uses real location names

---

## üîß Technical Changes

**File Modified:** `document_mode.py`

**Lines Changed:** ~760-920 (System message for numeric mode)

**Key Additions:**

1. **Rule #2 (NEW):** Only extract parameters that exist in data
2. **Rule #5 (UPDATED):** Enhanced NULL handling with context
3. **Examples Section (NEW):** Clear right/wrong scenarios
4. **Enforcement Rules (UPDATED):** Added violations for creating unwanted rows

---

## üß™ How to Test

1. **Start Application:**
   ```bash
   # Already running at http://localhost:8501
   ```

2. **Upload test file:**
   ```
   test_production_data.xlsx (already created)
   ```

3. **Test Queries:**

   **Query 1:** "Extract all data at each location"
   - Should ONLY show parameters that exist in file
   - Should NOT create rows for Pressure if Pressure column doesn't exist

   **Query 2:** "Extract temperature at each location"
   - Should ONLY show temperature rows
   - Should include NULLs if temperature column exists but is empty

   **Query 3:** "Extract pressure and temperature"
   - Should show both parameters IF they exist
   - Should explain if either doesn't exist

---

## ‚úÖ Success Criteria

### **Before Fix (V3.6):**
- ‚ùå Created rows for non-existent parameters ("Not found")
- ‚ùå Showed data for locations with no values
- ‚ùå Cluttered output with unnecessary NULL rows

### **After Fix (V3.6.1):**
- ‚úÖ Only shows parameters that exist in document
- ‚úÖ Only shows parameters user requested
- ‚úÖ Includes NULLs ONLY when column exists but cell is empty
- ‚úÖ Clean, focused output matching user intent

---

## üìä Comparison

### **Old Behavior:**
```
Query: "Extract all data"
Document: Temperature column only

Output: 
- Temperature rows (correct)
- Pressure rows with "Not found" (WRONG)
- Volume rows with "Not found" (WRONG)
```

### **New Behavior:**
```
Query: "Extract all data"
Document: Temperature column only

Output:
- Temperature rows (correct)
- No Pressure rows (correct - doesn't exist)
- No Volume rows (correct - doesn't exist)
```

---

## üéØ Summary

**Version:** V3.6.1  
**Date:** October 24, 2025  
**Status:** ‚úÖ Fixed and Running  

**What Changed:**
- Enhanced extraction logic to only show existing parameters
- Improved NULL handling to distinguish between:
  - "Column exists but contains no data" (include row)
  - "Parameter doesn't exist" (don't create row)
- Added clear examples and enforcement rules

**Impact:**
- Cleaner output
- Fewer unnecessary rows
- Better matches user intent
- Reduces confusion

**Application Status:** ‚úÖ Running at http://localhost:8501

**Next Step:** Test with your actual data and verify output only shows parameters that exist!
